#!/usr/bin/env perl

use strict;
use warnings;
use FindBin qw($Bin);
use lib "$Bin";
use AsmHub;
use File::Basename;

my $argc = scalar(@ARGV);

if ($argc != 3) {
  printf STDERR "usage: asmHubEnsGene.pl asmId asmId.names.tab bbi/asmId\n";
  printf STDERR "where asmId is the assembly identifier,\n";
  printf STDERR "and   asmId.names.tab is naming file for this assembly,\n";
  printf STDERR "and bbi/asmId is the path prefix to .ensGene.bb.\n";
  exit 255;
}

my $asmId = shift;
my $namesFile = shift;
my $bbiPrefix = shift;
my $ensGeneBbi = "$bbiPrefix.ensGene.bb";

if ( ! -s $ensGeneBbi ) {
  printf STDERR "ERROR: can not find ensGene bbi file:\n\t'%s'\n", $ensGeneBbi;
  exit 255;
}

my $em = "<em>";
my $noEm = "</em>";
my $assemblyDate = `grep -v "^#" $namesFile | cut -f9`;
chomp $assemblyDate;
my $ncbiAssemblyId = `grep -v "^#" $namesFile | cut -f10`;
chomp $ncbiAssemblyId;
my $organism = `grep -v "^#" $namesFile | cut -f5`;
chomp $organism;
my $geneCount = `bigBedInfo $ensGeneBbi | egrep "itemCount:|basesCovered:" | xargs echo | sed -e 's/itemCount/Gene count/; s/ basesCovered/; Bases covered/;'`;
chomp $geneCount;

print <<_EOF_
<h2>Description</h2>
<p>
This track shows the Ensembl gene, version 86, annotations on
the $assemblyDate $em${organism}$noEm/$asmId genome assembly.<br>
<br>
These gene predictions were generated by
<a href="http://www.ensembl.org/" target="_blank">Ensembl</a>.<br>
<br>
$geneCount
</p>

<h2>Credits</h2>

<p>
Thanks to Ensembl for providing this annotation. A description of the
<a href="http://www.ensembl.org/info/genome/genebuild/" target=_blank>process</a>
by which it was produced can be found on the Ensembl site.
</p>

<h2>References</h2>

<p>
Hubbard T, Barker D, Birney E, Cameron G, Chen Y, Clark L, Cox T, Cuff J,
Curwen V, Down T <em>et al</em>.
<a href="http://nar.oxfordjournals.org/content/30/1/38.full" target="_blank">
The Ensembl genome database project</a>.
<em>Nucleic Acids Res</em>. 2002 Jan 1;30(1):38-41.
PMID: <a href="http://www.ncbi.nlm.nih.gov/pubmed/11752248" target="_blank">11752248</a>; PMC: <a
href="http://www.ncbi.nlm.nih.gov/pmc/articles/PMC99161/" target="_blank">PMC99161</a>
</p>
_EOF_
   ;

